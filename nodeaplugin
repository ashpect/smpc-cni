#!/usr/bin/env bash
set -euo pipefail

# Simple CNI plugin for Node 1
# Pod IP: 10.244.0.20/32
# Host veth IP: 10.244.0.101/32

CMD="${CNI_COMMAND:-}"

# Read and discard stdin (CNI config); we don't need it here, but CNI sends it.
CONFIG="$(cat || true)"

if [[ "$CMD" == "ADD" ]]; then
  # Basic environment from CNI
  NETNS_PATH="${CNI_NETNS}"
  IFNAME="${CNI_IFNAME}"
  CONTAINER_ID="${CNI_CONTAINERID:-nocid}"

  # We'll create a unique name per container
  VETH_HOST="vethh-${CONTAINER_ID:0:8}"
  VETH_NETNS="vethc-${CONTAINER_ID:0:8}"

  POD_IP="10.244.0.20"
  POD_CIDR="${POD_IP}/32"
  HOST_IP="10.244.0.101"
  HOST_CIDR="${HOST_IP}/32"

  # Prepare a named netns so `ip -n` can use it
  NETNS_NAME="ns-${CONTAINER_ID:0:8}"
  mkdir -p /var/run/netns
  ln -sf "${NETNS_PATH}" "/var/run/netns/${NETNS_NAME}"

  # 1. Create veth pair
  ip link add "${VETH_HOST}" type veth peer name "${VETH_NETNS}"

  # 2. Move one end into the pod netns
  ip link set "${VETH_NETNS}" netns "${NETNS_NAME}"

  # 3. Assign IPs
  ip -n "${NETNS_NAME}" addr add "${POD_CIDR}" dev "${VETH_NETNS}"
  ip addr add "${HOST_CIDR}" dev "${VETH_HOST}"

  # 4. Rename pod-side veth to CNI_IFNAME (usually eth0)
  ip -n "${NETNS_NAME}" link set "${VETH_NETNS}" name "${IFNAME}"

  # 5. Bring interfaces up
  ip link set "${VETH_HOST}" up
  ip -n "${NETNS_NAME}" link set "${IFNAME}" up

  # 6. Routes inside pod: know about host and use it as default gw
  ip -n "${NETNS_NAME}" route add "${HOST_IP}" dev "${IFNAME}"
  ip -n "${NETNS_NAME}" route add default via "${HOST_IP}" dev "${IFNAME}"

  # 7. Route on node1 back to pod
  ip route add "${POD_CIDR}" dev "${VETH_HOST}" scope host || true

  # 8. MAC addresses for CNI result JSON
  MAC_HOST_VETH=$(ip link show "${VETH_HOST}" | awk '/link\/ether/ {print $2}')
  MAC_NETNS_VETH=$(ip -n "${NETNS_NAME}" link show "${IFNAME}" | awk '/link\/ether/ {print $2}')

  # Return CNI result JSON
  cat <<EOF
{
  "cniVersion": "1.0.0",
  "interfaces": [
    {
      "name": "${VETH_HOST}",
      "mac": "${MAC_HOST_VETH}"
    },
    {
      "name": "${IFNAME}",
      "mac": "${MAC_NETNS_VETH}",
      "sandbox": "${NETNS_PATH}"
    }
  ],
  "ips": [
    {
      "address": "${POD_CIDR}",
      "interface": 1
    }
  ]
}
EOF

elif [[ "$CMD" == "DEL" ]]; then
  CONTAINER_ID="${CNI_CONTAINERID:-nocid}"
  VETH_HOST="vethh-${CONTAINER_ID:0:8}"
  NETNS_NAME="ns-${CONTAINER_ID:0:8}"

  # Try to delete host veth; kernel will clean up peer if present
  ip link del "${VETH_HOST}" 2>/dev/null || true

  # Remove netns symlink if present
  rm -f "/var/run/netns/${NETNS_NAME}" 2>/dev/null || true

  exit 0
else
  echo "Unknown CNI_COMMAND: ${CMD}" >&2
  exit 1
fi
